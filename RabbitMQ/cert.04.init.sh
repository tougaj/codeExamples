#!/usr/bin/env bash

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥ —Å–µ—Ä–≤–µ—Ä—É —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ñ–∞–π–ª—ñ–≤
# !!! –î–∞–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –º–∞—î –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—å –∑ –ø—Ä–∞–≤–∞–º–∏ sudo !!!

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ç–∞–ª–æ–≥—É –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤
TLS_DIR="/etc/rabbitmq/tls"

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ç–∞–ª–æ–≥—É, —è–∫—â–æ –π–æ–≥–æ –Ω–µ —ñ—Å–Ω—É—î
echo "üìÅ –°—Ç–≤–æ—Ä—é—é –∫–∞—Ç–∞–ª–æ–≥ $TLS_DIR..."
mkdir -p "$TLS_DIR"

# –ó–º—ñ–Ω–∞ –≤–ª–∞—Å–Ω–∏–∫–∞ –∫–∞—Ç–∞–ª–æ–≥—É
echo "üîë –ó–º—ñ–Ω—é—é –≤–ª–∞—Å–Ω–∏–∫–∞ –∫–∞—Ç–∞–ª–æ–≥—É $TLS_DIR..."
chown rabbitmq:rabbitmq "$TLS_DIR"

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤
echo "üìÑ –ö–æ–ø—ñ—é—é —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏..."
cp ./testca/ca_certificate.pem "$TLS_DIR"
cp ./server/server_certificate.pem "$TLS_DIR"
cp ./server/private_key.pem "$TLS_DIR"

# –ó–º—ñ–Ω–∞ –≤–ª–∞—Å–Ω–∏–∫–∞ —Ñ–∞–π–ª—ñ–≤
echo "üõ†Ô∏è –ó–º—ñ–Ω—é—é –≤–ª–∞—Å–Ω–∏–∫–∞ —Ñ–∞–π–ª—ñ–≤..."
chown rabbitmq:rabbitmq "$TLS_DIR"/*

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É
echo "üîí –ù–∞–ª–∞—à—Ç–æ–≤—É—é –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É..."
chmod 600 "$TLS_DIR/private_key.pem"
chmod 640 "$TLS_DIR/ca_certificate.pem" "$TLS_DIR/server_certificate.pem"
chmod 750 "$TLS_DIR"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω—ñ —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ."
