#!/usr/bin/env python

import time
from typing import Optional

from transformers import AutoTokenizer
from vllm import LLM, SamplingParams

from common import texts

model = "google/gemma-3-4b-it"
# model = "google/gemma-3-12b-it"
# model = "mistralai/Mistral-7B-Instruct-v0.1"
llm = LLM(model=model,
          max_model_len=8192,  # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
          gpu_memory_utilization=0.95,  # –º–æ–∂–Ω–∞ –±—ñ–ª—å—à–µ, –±–æ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å
          swap_space=8,  # GB swap –Ω–∞ CPU (—è–∫—â–æ –Ω–µ –≤–∏—Å—Ç–∞—á–∏—Ç—å VRAM)
          # ‚ö°PREFIX CACHING - –∫–ª—é—á–æ–≤–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è!
          enable_prefix_caching=True,  # –∫–µ—à—É—î —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
          enable_chunked_prefill=True,  # –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–æ–≤–≥–∏—Ö –ø—Ä–æ–º–ø—Ç—ñ–≤
          )
# tokenizer = llm.get_tokenizer()
tokenizer = AutoTokenizer.from_pretrained(model)


def process(
    prompt: str,
    text: str,
    max_new_tokens: Optional[int] = 8192,
    temperature=0.1,
):
    messages_list = [
        {
            "role": "user",
            "content": (f"{prompt}\n\n{text}"),
        }
    ]
    texts = tokenizer.apply_chat_template(
        messages_list,
        tokenize=False,
        add_generation_prompt=True,
    )

    # Generate outputs
    start_time = time.time()

    if max_new_tokens is None:
        word_count = len(text.split())
        # –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ç—Ä–æ—Ö–∏ –¥–æ–≤—à–∞ –∑–∞ —Ñ—Ä–∞–Ω—Ü—É–∑—å–∫—É ‚Üí –º–Ω–æ–∂–∏–º–æ –Ω–∞ 1.3
        estimated_tokens = int(word_count * 3) + 20  # + –±—É—Ñ–µ—Ä
        max_new_tokens = max(100, estimated_tokens)  # –æ–±–º–µ–∂–µ–Ω–Ω—è
    print(f"üìü Max tokens: {max_new_tokens}")

    sampling_params = SamplingParams(
        temperature=temperature, top_p=0.95, max_tokens=max_new_tokens, n=1
    )

    outputs = llm.generate(texts, sampling_params)
    end_time = time.time()

    # Print the outputs.
    for output in outputs:
        # prompt = output.prompt
        for out in output.outputs:
            generated_text = out.text.strip()
            # print(f"üìù Prompt:\n{prompt!r},\n\nüì§ Generated text:\n{generated_text!r}")
            # print(f"üì§ Generated text:\n{generated_text!r}")
            print(f"üì§ Generated text:\n{generated_text}")
        print(f"‚è±Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–π–Ω—è–ª–∞ {end_time - start_time:.4f} —Å–µ–∫—É–Ω–¥")


def summarize(text: str, max_new_tokens: Optional[int]):
    process(
        """–¢–∏ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç–∏—Å–ª–∏—Ö –Ω–æ–≤–∏–Ω–Ω–∏—Ö —Ä–µ–∑—é–º–µ.
–û—Ç—Ä–∏–º—É—î—à —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ –∑ –Ω–æ–≤–∏–Ω–Ω–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞ –±—É–¥—å-—è–∫–æ—é –º–æ–≤–æ—é.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ **—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é** (3‚Äì5 —Ä–µ—á–µ–Ω—å), –¥–æ—Ç—Ä–∏–º—É—é—á–∏—Å—å —Ç–∞–∫–∏—Ö –ø—Ä–∞–≤–∏–ª:

1. **–ü–µ—Ä–µ–¥–∞–π –≥–æ–ª–æ–≤–Ω–∏–π –∑–º—ñ—Å—Ç —Ç–æ—á–Ω–æ –π —Å—Ç–∏—Å–ª–æ** ‚Äî –∑–æ—Å–µ—Ä–µ–¥—å—Å—è –Ω–∞ –∫–ª—é—á–æ–≤–∏—Ö —Ñ–∞–∫—Ç–∞—Ö, –ø–æ–¥—ñ—è—Ö —ñ —Ç–µ–∑–∞—Ö.
2. –Ø–∫—â–æ –≤ —Ç–µ–∫—Å—Ç—ñ —î —Ü—ñ –¥–∞–Ω—ñ, **–∑–∞–∑–Ω–∞—á –æ—Å–Ω–æ–≤–Ω–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤, –º—ñ—Å—Ü–µ, —á–∞—Å —ñ –ø—Ä–∏—á–∏–Ω—É –ø–æ–¥—ñ—ó.**
3. **–£–Ω–∏–∫–∞–π** –¥—Ä—É–≥–æ—Ä—è–¥–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –ø—Ä–∏–∫–ª–∞–¥—ñ–≤, —Ü–∏—Ç–∞—Ç, –æ—Ü—ñ–Ω–Ω–∏—Ö —Å—É–¥–∂–µ–Ω—å —ñ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Ç–æ–Ω—É.
4. –î–æ—Ç—Ä–∏–º—É–π—Å—è **–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–≥–æ, –æ–±‚Äô—î–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∏–ª—é.**
5. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–ø—Ä–∏—Ä–æ–¥–Ω—É, –∑—Ä–æ–∑—É–º—ñ–ª—É –π –≥—Ä–∞–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É** —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É.
6. **–£ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ–¥–∞–π –ª–∏—à–µ —Ä–µ–∑—é–º–µ** ‚Äî –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤, –ø–æ—è—Å–Ω–µ–Ω—å, –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –∞–±–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è.
–¢–µ–∫—Å—Ç –¥–ª—è —Å—É–º–∞—Ä–∏–∑–∞—Ü—ñ—ó:""",
        text,
        max_new_tokens=max_new_tokens,
        temperature=0.5,
    )


def translate(text: str):
    process(
        """–¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤–∏.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–∏–π —Ç–µ–∫—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é **—Ç–æ—á–Ω–æ –∑–∞ –∑–º—ñ—Å—Ç–æ–º**, –∞–ª–µ **–ø—Ä–∏—Ä–æ–¥–Ω–æ –π –≤–∏—Ä–∞–∑–Ω–æ –∑–∞ —Ñ–æ—Ä–º–æ—é**, –¥–æ—Ç—Ä–∏–º—É—é—á–∏—Å—å —Ç–∞–∫–∏—Ö –ø—Ä–∞–≤–∏–ª:
1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–≥—Ä–∞–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É, –ø—Ä–∏—Ä–æ–¥–Ω—É —Ç–∞ —Å—Ç–∏–ª—ñ—Å—Ç–∏—á–Ω–æ –¥–æ—Ä–µ—á–Ω—É** —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É.
2. **–ù–µ –ø–µ—Ä–µ–∫–ª–∞–¥–∞–π –¥–æ—Å–ª—ñ–≤–Ω–æ.** –£–Ω–∏–∫–∞–π –∫–∞–ª—å–æ–∫, —à—Ç—É—á–Ω–∏—Ö –∑–≤–æ—Ä–æ—Ç—ñ–≤ —ñ –±—É–∫–≤–∞–ª—å–Ω–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π ‚Äî –∑–∞–º—ñ–Ω—é–π —ó—Ö –Ω–∞ –ø—Ä–∏—Ä–æ–¥–Ω—ñ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫–∏ –∞–±–æ —ñ–¥—ñ–æ–º–∞—Ç–∏—á–Ω—ñ –≤–∏—Ä–∞–∑–∏.
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ª–∞–ø–∫–∏ **¬´...¬ª** –∑–∞–º—ñ—Å—Ç—å —ñ–Ω–æ–∑–µ–º–Ω–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ (‚Äû...‚Äú, "...", ‚Äò...‚Äô —Ç–æ—â–æ), –¥–æ—Ç—Ä–∏–º—É—é—á–∏—Å—å –ø—Ä–∞–≤–∏–ª –ø—É–Ω–∫—Ç—É–∞—Ü—ñ—ó.
4. –ó–∞ –ø–æ—Ç—Ä–µ–±–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É–π **—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è Markdown**:
   * –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`#`, `##`),
   * —Å–ø–∏—Å–∫–∏,
   * **–∂–∏—Ä–Ω–∏–π** –∞–±–æ *–∫—É—Ä—Å–∏–≤–Ω–∏–π* —Ç–µ–∫—Å—Ç,
   * —Ü–∏—Ç–∞—Ç–∏ —Ç–æ—â–æ.
5. –ù–µ –¥–æ–¥–∞–≤–∞–π –ø–æ—è—Å–Ω–µ–Ω—å, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤, –ø—Ä–∏–º—ñ—Ç–æ–∫ —á–∏ —Å–ª—É–∂–±–æ–≤–∏—Ö —Ñ—Ä–∞–∑.
6. –Ø–∫—â–æ –Ω–∞–¥–∞–Ω–æ —Ç–µ–∫—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –∞–±–æ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é –º–æ–≤–æ—é, —Ç–æ –ø–µ—Ä–µ–∫–ª–∞–¥–∞—Ç–∏ –π–æ–≥–æ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ. –í —Ç–∞–∫–æ–º—É —Ä–∞–∑—ñ –ø—Ä–æ—Å—Ç–æ –≤–∏–≤–µ–¥–∏ –ø—É—Å—Ç–∏–π —Ä—è–¥–æ–∫.
7. **–£ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ–¥–∞–≤–∞–π –ª–∏—à–µ –ø–µ—Ä–µ–∫–ª–∞–¥–µ–Ω–∏–π —Ç–µ–∫—Å—Ç.**
–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞–¥—É:\n\n""",
        text,
    )


def complex_processing(text: str):
    process(
        """–¢–∏ ‚Äî –±–∞–≥–∞—Ç–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Ç–µ–∫—Å—Ç—ñ–≤. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è:

1. **–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–≤–∏:**

   * –í–∏–∑–Ω–∞—á –º–æ–≤—É –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É —Ç–∞ –≤—ñ–¥–¥–∞–π —ó—ó —É —Ñ–æ—Ä–º–∞—Ç—ñ **ISO 639-1** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `uk`, `ru`, `en`, `fr`).

2. **–ü–µ—Ä–µ–∫–ª–∞–¥ (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):**

   * –Ø–∫—â–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç **–Ω–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é —ñ –Ω–µ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é**, –ø–µ—Ä–µ–∫–ª–∞–¥–∏ –π–æ–≥–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.
   * –ü–µ—Ä–µ–∫–ª–∞–¥ –º–∞—î:

     * –±—É—Ç–∏ –ø—Ä–∏—Ä–æ–¥–Ω–∏–º —ñ –≥—Ä–∞–º–æ—Ç–Ω–∏–º —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º ‚úçÔ∏è
     * –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ **—Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ä–∏–≥—ñ–Ω–∞–ª—É** (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –∞–±–∑–∞—Ü–∏, —Å–ø–∏—Å–∫–∏, —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è) üèóÔ∏è
     * –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ Markdown —Ç–∞–º, –¥–µ –¥–æ—Ä–µ—á–Ω–æ üìë
     * –∑–∞–º—ñ–Ω—é–≤–∞—Ç–∏ –ª–∞–ø–∫–∏ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ (¬´‚Ä¶¬ª) üìù
     * —É–Ω–∏–∫–∞—Ç–∏ –∫–∞–ª—å–∫–∏ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –ø—Ä–∏—Ä–æ–¥–Ω–∏–π —Å—Ç–∏–ª—å üåø
   * –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤–∫–ª—é—á–∞–π –ø–æ–ª–µ `"translation"`.

3. **–í–∏–Ω—è—Ç–∫–∏:**

   * –Ø–∫—â–æ —Ç–µ–∫—Å—Ç **—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∞–±–æ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é**, –ø–µ—Ä–µ–∫–ª–∞–¥–∞—Ç–∏ –π–æ–≥–æ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —ñ –ø–æ–ª–µ `"translation"` —É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ **–Ω–µ –≤–∫–ª—é—á–∞—Ç–∏**.

4. **–°—É–º–∞—Ä–∏–∑–∞—Ü—ñ—è:**

   * –£ –±—É–¥—å-—è–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É —Å—Ç–≤–æ—Ä–∏ –∫–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ (3‚Äì5 —Ä–µ—á–µ–Ω—å) —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, —è–∫–µ:

     * –ø–µ—Ä–µ–¥–∞—î –≥–æ–ª–æ–≤–Ω—ñ —Ñ–∞–∫—Ç–∏ —Ç–∞ —Ç–µ–∑–∏ üì∞
     * –∑–∞–∑–Ω–∞—á–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤, —á–∞—Å, –º—ñ—Å—Ü–µ —Ç–∞ –ø—Ä–∏—á–∏–Ω–∏ –ø–æ–¥—ñ—ó (—è–∫—â–æ —î) üìç
     * –∑–±–µ—Ä—ñ–≥–∞—î –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π —ñ —Å—Ç–∏—Å–ª–∏–π —Å—Ç–∏–ª—å ‚öñÔ∏è

**–§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É (JSON):**

```json
{
  "lang_original": "xx",
  "translation": "–¢—É—Ç –ø–µ—Ä–µ–∫–ª–∞–¥–µ–Ω–∏–π —Ç–µ–∫—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∑—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏‚Ä¶",
  "summary": "–¢—É—Ç —Å—Ç–∏—Å–ª–∏–π –≤–∏–∫–ª–∞–¥ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é‚Ä¶"
}
```

> –Ø–∫—â–æ –º–æ–≤–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É ‚Äî `uk` –∞–±–æ `ru`, —Ç–æ –ø–æ–ª–µ `"translation"` –Ω–µ –≤–∫–ª—é—á–∞—Ç–∏.

**–í—Ö—ñ–¥:**

```
{–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ}
```

**–í–∏—Ö—ñ–¥:**
JSON –∑:

* `lang_original` (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)
* `summary` (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)
* `translation` (–ª–∏—à–µ —è–∫—â–æ –º–æ–≤–∞ ‚â† `uk` —ñ ‚â† `ru`).
""",
        text,
    )


for text in texts:
    translate(text)
    # summarize(text, 300)
    # complex_processing(text)
    print('-'*50)
